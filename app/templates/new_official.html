<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if official %}Modificar Funcionario{% else %}Registrar Nuevo Funcionario{% endif %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="dashboard-container">
        <button class="hamburger" aria-label="Toggle Menu">☰</button>
        <main class="main-content">
            <header class="header">
                <div class="user-profile">
                    <img src="{{ current_user.profile_picture if current_user.profile_picture else url_for('static', filename='images/user.png') }}" alt="User Profile" class="user-icon">
                    <div class="user-dropdown">
                        <p class="user-name">{{ current_user.username }}</p>
                    </div>
                </div>
            </header>
            <section class="content">
                <h2>{% if official %}Modificar Funcionario{% else %}Registrar Nuevo Funcionario{% endif %}</h2>
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="message {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                <form method="POST" action="{{ url_for('official.new_or_update_official', id=official.id if official else '') }}" id="officialForm">
                    <input type="hidden" name="official_id" value="{{ official.id if official else '' }}">
                    <!-- CSRF Token será obtenido de la cookie por JavaScript -->
                    <input type="hidden" name="csrf_token" id="csrf_token" value="">
                    <div class="form-sections">
                        <div class="form-section" data-section="1">
                            <h3>Información Personal</h3>
                            <div class="form-group">
                                <label for="first_name">Nombre:</label>
                                <input type="text" id="first_name" name="first_name" value="{{ official.first_name if official else '' }}" required>
                            </div>
                            <div class="form-group">
                                <label for="last_name">Apellido:</label>
                                <input type="text" id="last_name" name="last_name" value="{{ official.last_name if official else '' }}" required>
                            </div>
                            <div class="form-group">
                                <label for="date_of_birth">Fecha de Nacimiento:</label>
                                <input type="date" id="date_of_birth" name="date_of_birth" value="{{ official.date_of_birth.strftime('%Y-%m-%d') if official and official.date_of_birth else '' }}" required>
                            </div>
                        </div>
                        <div class="form-section" data-section="2">
                            <h3>Información Laboral</h3>
                            <div class="form-group">
                                <label for="workplace">Lugar de Trabajo:</label>
                                <input type="text" id="workplace" name="workplace" value="{{ official.workplace if official else '' }}" required>
                            </div>
                            <div class="form-group">
                                <label for="level">Nivel:</label>
                                <input type="text" id="level" name="level" value="{{ official.level if official else '' }}" required>
                            </div>
                            <div class="form-group">
                                <label for="image">Imagen (URL):</label>
                                <input type="text" id="image" name="image" value="{{ official.image if official else '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="navigation-buttons">
                        <button type="button" class="card-link" id="prevBtn" style="display: none;">Anterior</button>
                        <button type="button" class="card-link" id="nextBtn">Siguiente</button>
                        <button type="submit" class="card-link" id="saveBtn" style="display: none;">Guardar</button>
                    </div>
                </form>
            </section>
        </main>
    </div>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sections = document.querySelectorAll('.form-section');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const saveBtn = document.getElementById('saveBtn');
            const csrfTokenInput = document.getElementById('csrf_token');
            const form = document.getElementById('officialForm');
            let currentSection = 1;

            // Función para obtener cookie por nombre
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            // Obtener CSRF token directamente de las cookies
            function loadCSRFToken() {
                const csrfToken = getCookie('csrf_access_token');
                if (csrfToken) {
                    csrfTokenInput.value = csrfToken;
                    console.log('CSRF token loaded from cookie:', csrfToken);
                    return true;
                } else {
                    console.error('CSRF token not found in cookies');
                    // Como fallback, intentar obtenerlo del servidor
                    fetch('/get-csrf-token', {
                        method: 'GET',
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.csrf_token) {
                            csrfTokenInput.value = data.csrf_token;
                            console.log('CSRF token fetched from server:', data.csrf_token);
                        } else {
                            console.error('Could not get CSRF token:', data.error || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching CSRF token:', error);
                    });
                    return false;
                }
            }

            // Cargar el token CSRF al inicializar
            loadCSRFToken();

            // Verificar token CSRF antes del envío del formulario
            /**form.addEventListener('submit', function(e) {
                if (!csrfTokenInput.value) {
                    e.preventDefault();
                    console.error('Form submission blocked: No CSRF token');
                    alert('Token CSRF no disponible. Por favor, recarga la página.');
                    return false;
                }
                console.log('Form submitted with CSRF token:', csrfTokenInput.value);
            });**/

            function showSection(sectionNum) {
                sections.forEach(section => section.classList.remove('active'));
                const activeSection = document.querySelector(`.form-section[data-section="${sectionNum}"]`);
                if (activeSection) {
                    activeSection.classList.add('active');
                    currentSection = sectionNum;
                    prevBtn.style.display = sectionNum > 1 ? 'inline-flex' : 'none';
                    nextBtn.style.display = sectionNum < sections.length ? 'inline-flex' : 'none';
                    saveBtn.style.display = sectionNum === sections.length ? 'inline-flex' : 'none';
                }
            }

            prevBtn.addEventListener('click', () => {
                if (currentSection > 1) {
                    showSection(currentSection - 1);
                }
            });

            nextBtn.addEventListener('click', () => {
                if (currentSection < sections.length) {
                    showSection(currentSection + 1);
                }
            });

            // Initialize with section 1
            showSection(1);
        });
    </script>
</body>
</html>